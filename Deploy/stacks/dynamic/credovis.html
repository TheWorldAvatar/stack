<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <!-- ===== CUSTOMISABLE ===== -->
        <title>CReDo: All</title>
        <!-- ===== CUSTOMISABLE ===== -->

        <!-- JS -->
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
        <script src="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js" ></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-moment/1.0.0/chartjs-adapter-moment.js"></script>
        <script src="./dtvf/dtvf.min.js"></script>

        <!-- ===== CUSTOMISABLE ===== -->
        <!-- JavaScript files to provide functionality specifically for this visualisation instance can go here. -->
        <script src="./legend.js"></script>
        <script src="./connections.js"></script>
        <script src="./timesteps.js"></script>
        <!-- ===== CUSTOMISABLE ===== -->

        <!-- CSS -->
        <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/hummingbird-dev/hummingbird-treeview@v3.0.4/hummingbird-treeview.min.css" rel="stylesheet">
        <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" rel="stylesheet">
        <link href="./dtvf/dtvf.min.css" rel="stylesheet" />

        <!-- ===== CUSTOMISABLE ===== -->
        <!-- CSS files to provide styling specifically for this visualisation instance can go here. -->
        <link href="./local.css" rel="stylesheet" />
        <!-- ===== CUSTOMISABLE ===== -->

    </head>
    <body>
        <!-- Container the map will be added to -->
        <div id="map"></div>

        <!-- Element for depth of field overlay -->
        <div id="tiltShift"></div>

        <!-- Element the map controls will be added to (normally on the left) -->
        <div id="controlsContainer">
            <div id="controlContainer">

                <!-- Camera controls -->
                <div id="cameraContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Camera</p>
                        <div class="tooltip">
                            <label class="switch"><input type="checkbox" onclick="MapboxUtils.setTiltshift(this.checked)"><span class="slider round"><p>DoF</p></label>
                            <span class="tooltiptext">Toggle depth of field effect</span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <a href="#" onclick="MapboxUtils.resetCamera()">Reset to default</a><br/>
                    </div>
                </div>

                <!-- Terrain controls -->
                <div id="terrainContainer" class="controlBlock">
                    <div id="controlTitle" class="controlTitle">
                        <p>Imagery</p>
                        <div class="tooltip">
                            <label class="switch"><input type="checkbox" onclick="MapboxUtils.set3DTerrain(this.checked)"><span class="slider round"><p>3D</p></label>
                            <span class="tooltiptext">Toggle 3D terrain</span>
                        </div>
                    </div>
                    <div id="imageryContainer" class="controlContents">
                    </div>
                </div>

                <!-- Layer controls -->
                <div id="layerContainer" class="controlBlock">
                    <div id="controlTitle"  class="controlTitle">
                        <p>Layers</p>
                        <div class="tooltip" id="placenameContainer">
                            <label class="switch"><input id="pnSwitch" type="checkbox" onclick="MapboxUtils.setPlacenames(this.checked)" checked><span class="slider round"><p>PNs</p></label>
                            <span class="tooltiptext">Toggle place names, labels, and roads </span>
                        </div>
                    </div>
                    <div class="controlContents">
                        <div id="layerTreeContainer">
                            <div class="hummingbird-treeview-converter"></div>
                        </div>
                    </div>
                </div>

              	<!-- Scenario change control -->
                  <div id="scenarioChangeContainer" class="controlBlock expanded" onclick="manager.showScenarioSelector()">
                    <div class="tooltip">
                        <p><b>Change scenario</b></p>
                        <span class="tooltiptext right" style="width: 225px !important;">Change the current scenario</span>
						<div id="currentScenarioName" style="font-style: italic; font-size: 8.5pt;"></div>
                    </div>
                </div>

                <div id="helpandsearch">
                    <!-- Search icon -->
                    <div id="searchIconContainer" class="controlBlock expanded" onclick="manager.openSearch()">
                        <div class="tooltip" id="coordEditor">
                            <i class="fas fa-search fa-lg"></i>
                            <span class="tooltiptext right" style="width: 100px !important;">Feature search</span>
                        </div>
                    </div>

                    <!-- Help icon -->
                    <div id="helpContainer" class="controlBlock expanded" onclick="openHelpURL()">
                        <div class="tooltip" id="coordEditor">
                            <i class="fas fa-question fa-lg"></i>
                            <span class="tooltiptext right">Help</span>
                        </div>
                    </div>
                 </div>

                <!-- Container for developer info -->
                <div id="developerContainer" class="controlBlock" style="display: none;">
                    <div class="tooltip" id="coordEditor" style="float: right;">
                        <i class="fas fa-pencil-alt" onclick="event.stopPropagation(); manager.getControlHandler().editInfoPanel()"></i>
                        <span class="tooltiptext">Change map position</span>
                    </div>
                    <div id="coordsContainer" style="width: 100%; height: 100%;"></div>
                </div>

                <div id="logoutContainer" class="controlBlock expanded" onclick="logout()">
                    <div class="tooltip" id="coordEditor">
                        <i class="fas fa-sign-out-alt fa-lg"></i>
                        <span class="tooltiptext right">Log Out</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- Side panel for content and metdata -->
        <div id="sidePanel" class="large expanded">
            <div class="tooltip" id="slideButtonContainer">
                <i class="fas fa-chevron-right" id="slideButton" width="16px" class="leftButton" height="16px" onclick="manager.getPanelHandler().toggleExpansion()"></i>
                <span class="tooltiptext">Expand/Collapse</span>
            </div>
            <div class="tooltip" id="expandButtonContainer">
                <i class="fas fa-expand" id="expandButton" width="16px" class="rightButton" height="16px" onclick="manager.getPanelHandler().toggleMode()"></i>
                <span class="tooltiptext">Maximise/Minimise</span>
            </div>
            <div id="sidePanelInner">
                <ul>
                    <li><a id="generalLink" href="#sidePanelGeneral">About</a></li>
                    <li><a href="#sidePanelAck">Acknowledgements</a></li>
                    <li><a href="#sidePanelLegend">Legend</a></li>
					<li><a href="#sidePanelFailure">Failure Types</a></li>
                    <li><a href="#sidePanelLinks">Links</a></li>
                </ul>
                <div id="sidePanelGeneral">
                    <div id="titleContainer" onclick="manager.moveMapToFeature()"></div>
                    <div id="contentContainer"></div>
                    <div id="legendContainer"></div>
                    <div id="footerContainer">
                        <div id="footerContent"></div>
                    </div>
                </div>
                <div id="sidePanelAck"></div>
                <div id="sidePanelLegend"></div>
				<div id="sidePanelFailure">
					<h3>Types of failure</h3>
					<hr/>
					<p>
						The coloured borders around the assets allow users to see how the cascade of problems caused by the flood traverses through the combined asset network.
						<br/><br/>
						Types of failure used within this visualisation are defined below; please see the "Legend" tab for an example image of site icons under each failure type.
						<br/>
					</p>
					<ul style="padding-inline-start: 24px !important;">
						<li style="list-style-type: circle !important; padding-bottom: 12px;"><b>Direct failure:</b> a red circular border around an icon indicates an asset that has failed because there is flooding at that location.</li>
						<li style="list-style-type: circle !important; padding-bottom: 12px;"><b>Indirect failure:</b> an orange octagonal border indicates an asset that has failed because of a problem upstream. For example, a secondary substation that is no longer receiving power.</li>
						<li style="list-style-type: circle !important; padding-bottom: 12px;"><b>Secondary failure:</b> a grey square border indicates an asset that is still working, but that has some other problem. For example, a substation that is providing power but that has perhaps lost telecoms or water.</li>
						<li style="list-style-type: circle !important; padding-bottom: 12px;"><b>Unsupplied connection:</b> a connection with an orange highlight denotes a connection that is not transmitting power/water/communications due to an upstream issue.</li>
					</ul>
					<br/><br/>
					<h3>State values</h3>
					<hr/>
					<p>
						Each site has a number of input and output states, these states represent the ability of the site to recieve or output power, water, or communications; a state for the current flooding status is also present.
						<br/><br/>
						The numerical value of each state is detailed below.
						<br/>
					</p>
					<ul style="padding-inline-start: 24px !important;">
						<li style="list-style-type: circle !important; padding-bottom: 12px;">The power, water, sewage, and communication states range from a value of 0 (nothing is being recieved/output), and 1 (the relevant quantity is being recieved/output correctly).
						<li style="list-style-type: circle !important; padding-bottom: 12px;">The flood state denotes if the current site has flood water higher that its defense level; ranges from 0 (site is considered dry), to 1 (site is considered flooded).
					</ul>
				</div>
                <div id="sidePanelLinks"></div>
            </div>
            <div id="returnContainer" style="display: none;">
                <div id="innerReturnContainer">
                    <a href="#" onclick="manager.getPanelHandler().returnToDefault()"><i class="fas fa-arrow-left" width="16px" height="16px"></i> Return</a>
                </div>
            </div>
        </div>

        <!-- Code entry point -->
        <script>
            $("#sidePanelInner").tabs();

            // Load the "Legend" tab by default
            $("#sidePanelInner").tabs("option", "active", 1);

            // ===== CUSTOMISABLE =====
            // Enter Mapbox account name and API key here!
            MapHandler.MAP_USER = "cmclinnovations-credo";
            MapHandler.MAP_API = "pk.eyJ1IjoiY21jbGlubm92YXRpb25zLWNyZWRvIiwiYSI6ImNreGFicGxzeTJqNWEydW8xYXc1NWN1a2wifQ.QsALOHmgg9Ne1XmAM0Y2xQ";
            // ===== CUSTOMISABLE =====

            // Create a new manager instance
            var manager = new Manager(MapProvider.MAPBOX);
            window.manager = manager;

            // Only start the map after settings have been read.
            manager.loadSettings().then(() => start());

            /**
             * Starts the visualisation setup process.
             */
            function start() {
                // Initialise the map object
                manager.initialiseMap();
               
                // ===== CUSTOMISABLE =====
                document.getElementById("titleContainer").style.display = "none";
                document.getElementById("legendContainer").style.display = "none";
                document.getElementById("footerContainer").style.display = "none";

                let about = document.getElementById("contentContainer");
                about.innerHTML += `
                    <div style="font-size: 12pt">
                        <div style="text-align: center;">
                            <img src="credo-logo.svg" width="300px" style="margin-bottom: 20px;">
                        </div>
                        <hr/><br/>
                        <p>CReDo, the Climate Resilience Demonstrator, is a pioneering climate change adaptation digital twin project that provides a practical example of how 
                        connected data can improve climate adaptation and resilience across a system of systems.</p>
                        <br/><br/>
                        <p>Learn more about CReDo:</p>
                        <br/>
                        <iframe width="425px" height="250px" style="padding-left: 15px;" src="https://www.youtube.com/embed/71NAk8JB46E" title="CReDo - Increasing climate resilience through cross-sector data sharing in a connected digital twin" frameborder=0 allowfullscreen></iframe>​
                        <br/><br/><br/>
                        <p>Learn about how CReDo works:</p>
                        <br/> 
                        <iframe width="425px" height="250px" style="padding-left: 15px;" src="https://www.youtube.com/embed/TEB5A1FnwCs" title="Showcasing the Climate Resilience Demonstrator (CReDo) webinar 7.3.23" frameborder="0" allowfullscreen></iframe>​
                        <br/><br/><br/>
                        <p>Read more about CReDo on the <a href="https://digitaltwinhub.co.uk/credo/" target="_blank">DT Hub</a>.</p>
                    </div>
                `;

                let ack = document.getElementById("sidePanelAck");
                ack.innerHTML = `
                    <div style="font-size: 12pt">
                        <div style="text-align: center;">
                            <a href="credo-partners.png" target="_blank"><img src="credo-partners.png" border=1 width="450px" style="margin-bottom: 20px;"></a>
                        </div>
                        <p>CReDo has been delivered through a first-of-its-kind collaboration between academia, utilities networks and government.</p>
                        <br/>
                        <p>Collaborating on the first phase of CReDo were Anglian Water, BT and UK Power Networks, who used their asset and operations data as well as 
                        weather data supplied by the Met Office on a secure, shared basis to inform an increased level of infrastructure resilience. These data sets 
                        were securely shared to create a digital twin of the infrastructure system for energy, water and telecoms. This enabled insights from the data 
                        that can inform decision making concerning capital and operational planning and real time operations reducing the cost and disruptive impact 
                        of extreme weather events. CReDo was delivered through a collaboration of research centres (Universities of Cambridge, Edinburgh, Newcastle, 
                        and Warwick along with the Science and Technology Facilities Council, and the Joint Centre of Excellence in Environmental Intelligence) and 
                        industry, funded by BEIS, the Connected Places Catapult and the University of Cambridge.</p>
                    </div>
                `;
                // ===== CUSTOMISABLE =====

                // Save general tab state as default
                manager.getPanelHandler().storeDefault();

                // Build the legend
                buildLegend();

                // Once the underlying style has loaded...
                MapHandler.MAP.on("style.load", function() {
                    // Ensure placenames setting is maintained
                    let pnSwitch = document.getElementById("pnSwitch");
                    if(pnSwitch != null && !pnSwitch.checked) {
                        MapboxUtils.setPlacenames(pnSwitch.checked);
                    }

                    // Load registered images and linked files
                    manager.loadImagesAndLinks().then(() => {

                        // TODO: This SHOULD only kick in after all images have been loaded and added to the map,
                        // but I cannot get the nested Promises to wait for each other properly. To avoid the
                        // rares cases that issues do appear, I've added a small sleep call. - Michael

                        new Promise(r => setTimeout(r, 250)).then(() => {
							// Check if the settings contains a scenarios endpoint
                            let scenariosEnabled = manager.checkForScenarios();
							
							if(scenariosEnabled) {
								// Show the scenario selection pane
								manager.showScenarioSelector();

							} else {
                                if(Manager.DATA_STORE.dataGroups.length === 0) {
                                    // Plot the default visible data, rereading the definitions
                                    manager.loadData().then(function() {
                                        manager.plotData();
                                    });

                                } else {
                                    // Plot the data, WITHOUT rereading the definitions
                                    manager.plotData();
                                }
								
							}
                        });
                    });
                });
            }
          
        </script>
    </body>
</html>